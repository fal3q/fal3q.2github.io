<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer</title>
    <style>
        @font-face {
            font-family: 'MC-font';
            src: url('MinecraftRegular-Bmg3.otf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: transparent;
            overflow: hidden;
        }

        .Timer, .Deaths, .TimerBoss, .DeathsBoss, .NameBoss {
            color: white;
            -webkit-text-stroke: 3px black;
            font-size: 90px;
            letter-spacing: 5px;
            font-family: 'MC-font', sans-serif;
        }

        .Boss {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="Deaths">Smierci: 0</div>
    <div class="Timer">Time: 00:00</div>
    <div class="Boss" style="visibility: hidden;">
        <div class="NameBoss"></div>
        <div class="DeathsBoss"></div>
        <div class="TimerBoss"></div>
     </div>
     <script>
    // Główne zmienne (pobieranie z pamięci)
    let Time = localStorage.getItem("timer_time") ? parseInt(localStorage.getItem("timer_time")) : 0;
    let Deaths = localStorage.getItem("Deaths_count") ? parseInt(localStorage.getItem("Deaths_count")) : 0;
    let isRunning = false;

    // Zmienne Bossa
    let NameBoss = localStorage.getItem("timerBoss_name") || "";
    let TimeBoss = localStorage.getItem("timerBoss_time") ? parseInt(localStorage.getItem("timerBoss_time")) : 0;
    let DeathsBoss = localStorage.getItem("DeathsBoss_count") ? parseInt(localStorage.getItem("DeathsBoss_count")) : 0;
    let isRunningBoss = false;

    // Elementy DOM
    const display_deaths = document.querySelector(".Deaths");
    const display_time = document.querySelector(".Timer");
    const fullboss = document.querySelector(".Boss");
    const display_name_boss = document.querySelector(".NameBoss");
    const display_deaths_boss = document.querySelector(".DeathsBoss");
    const display_time_boss = document.querySelector(".TimerBoss");

    // Inicjalizacja widoczności
    if (NameBoss.trim() !== "") {
        fullboss.style.visibility = "visible";
    }

    updateDisplay();

    function updateDisplay() {
        // Render czasu głównego
        let h = Math.floor(Time / 3600);
        let m = Math.floor((Time % 3600) / 60);
        let s = Math.floor(Time % 60);
        let hDisp = h > 0 ? (h < 10 ? '0' + h : h) + ":" : "";
        let mDisp = (m < 10 ? '0' + m : m) + ":";
        let sDisp = s < 10 ? '0' + s : s;

        display_deaths.textContent = "Smierci: " + Deaths;
        display_time.textContent = "Time: " + hDisp + mDisp + sDisp;

        localStorage.setItem("Deaths_count", Deaths);
        localStorage.setItem("timer_time", Time);
        
        // Render Bossa - tylko jeśli panel jest widoczny
        if (fullboss.style.visibility === "visible") {
            // Jeśli jakimś cudem NameBoss jest puste, weź z localStorage
            if (!NameBoss || NameBoss.trim() === "") {
                NameBoss = localStorage.getItem("timerBoss_name") || "Brak Nazwy";
            }

            display_name_boss.textContent = "Boss: " + NameBoss;

            let hb = Math.floor(TimeBoss / 3600);
            let mb = Math.floor((TimeBoss % 3600) / 60);
            let sb = Math.floor(TimeBoss % 60);
            let hbD = hb > 0 ? (hb < 10 ? '0' + hb : hb) + ":" : "";
            let mbD = (mb < 10 ? '0' + mb : mb) + ":";
            let sbD = sb < 10 ? '0' + sb : sb;

            display_deaths_boss.textContent = "Smierci: " + DeathsBoss;
            display_time_boss.textContent = "Time: " + hbD + mbD + sbD;
            
            localStorage.setItem("timerBoss_name", NameBoss);
            localStorage.setItem("DeathsBoss_count", DeathsBoss);
            localStorage.setItem("timerBoss_time", TimeBoss);
        }
    }

    function TimeUp() {
        if (isRunning) Time++;
        if (fullboss.style.visibility === "visible" && isRunningBoss) TimeBoss++;
        updateDisplay();
    }

    function connectTwitch() {
        if (typeof ComfyJS !== "undefined") {
            ComfyJS.onCommand = (user, command, message, flags) => {
                if (flags.broadcaster || flags.mod) {
                    
                    if (command === "tbossstart") {
                        // LOGIKA "BETON":
                        // Jeśli wiadomość jest pusta lub to tylko spacje...
                        if (!message || message.trim().length === 0) {
                            // ...to sprawdzamy czy mamy już jakąś nazwę w pamięci
                            if (NameBoss && NameBoss.trim() !== "") {
                                isRunningBoss = true;
                                fullboss.style.visibility = "visible";
                                updateDisplay();
                            }
                            return; // KONIEC. Nie dotykamy zmiennej NameBoss!
                        }

                        // Jeśli doszliśmy tutaj, to znaczy że message MA TREŚĆ (nowy boss)
                        NameBoss = message;
                        DeathsBoss = 0;
                        TimeBoss = 0;
                        isRunningBoss = true;
                        fullboss.style.visibility = "visible";
                        updateDisplay();
                    }

                    if (command === "tbossstop") {
                        fullboss.style.visibility = "hidden";
                        isRunningBoss = false;
                        NameBoss = "";
                        localStorage.setItem("timerBoss_name", "");
                        updateDisplay();
                    }

                    // Pozostałe komendy
                    if (command === "tstart") {
                        isRunning = true;
                        if (fullboss.style.visibility === "visible") isRunningBoss = true;
                    }
                    if (command === "tstop") {
                        isRunning = false;
                        isRunningBoss = false;
                    }
                    if (command === "tbosspause") {
                        isRunningBoss = false;
                    }
                    if (command === "t+") {
                        Deaths++;
                        if (fullboss.style.visibility === "visible") DeathsBoss++;
                    }
                    if (command === "t-") {
                        if (Deaths > 0) Deaths--;
                        if (fullboss.style.visibility === "visible" && DeathsBoss > 0) DeathsBoss--;
                    }
                    if (command === "treset") {
                        Time = 0;
                        if (fullboss.style.visibility === "visible") TimeBoss = 0;
                    }
                    updateDisplay();
                }
            };
            ComfyJS.Init("damiano00o");
        } else {
            setTimeout(connectTwitch, 500);
        }
    }

    setInterval(TimeUp, 1000);
    connectTwitch();
</script>
</body>

</html>
