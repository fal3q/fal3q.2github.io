<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer</title>
    <style>
        @font-face {
            font-family: 'MC-font';
            src: url('MinecraftRegular-Bmg3.otf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: transparent;
            overflow: hidden;
        }

        .Timer, .Deaths, .TimerBoss, .DeathsBoss, .NameBoss {
            color: white;
            -webkit-text-stroke: 3px black;
            font-size: 90px;
            letter-spacing: 5px;
            font-family: 'MC-font', sans-serif;
        }

        .Boss {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="Deaths">Smierci: 0</div>
    <div class="Timer">Time: 00:00</div>
    <div class="Boss" style="visibility: hidden;">
        <div class="NameBoss"></div>
        <div class="DeathsBoss"></div>
        <div class="TimerBoss"></div>
     </div>
     <script>
    // --- INICJALIZACJA DANYCH ---
    let Time = parseInt(localStorage.getItem("timer_time")) || 0;
    let Deaths = parseInt(localStorage.getItem("Deaths_count")) || 0;
    let isRunning = false;

    let NameBoss = localStorage.getItem("timerBoss_name") || "";
    let TimeBoss = parseInt(localStorage.getItem("timerBoss_time")) || 0;
    let DeathsBoss = parseInt(localStorage.getItem("DeathsBoss_count")) || 0;
    let isRunningBoss = false;

    // --- ELEMENTY ---
    const el = {
        deaths: document.querySelector(".Deaths"),
        time: document.querySelector(".Timer"),
        bossCont: document.querySelector(".Boss"),
        bossName: document.querySelector(".NameBoss"),
        bossDeaths: document.querySelector(".DeathsBoss"),
        bossTime: document.querySelector(".TimerBoss")
    };

    // --- FUNKCJA RENDERUJĄCA (STRAŻNIK) ---
    function updateDisplay() {
        // Główny licznik
        const h = Math.floor(Time / 3600);
        const m = Math.floor((Time % 3600) / 60);
        const s = Time % 60;
        el.deaths.textContent = `Smierci: ${Deaths}`;
        el.time.textContent = `Time: ${h > 0 ? (h < 10 ? '0' + h : h) + ":" : ""}${(m < 10 ? '0' + m : m)}:${(s < 10 ? '0' + s : s)}`;

        localStorage.setItem("Deaths_count", Deaths);
        localStorage.setItem("timer_time", Time);

        // Sekcja Bossa
        if (el.bossCont.style.visibility === "visible") {
            // KLUCZOWE ZABEZPIECZENIE:
            // Jeśli NameBoss jest puste/null/undefined, bierzemy ostatnią zapisaną nazwę.
            // Jeśli w ogóle nie ma nazwy, wpisujemy "Wybierz Bossa", żeby nie było pustki.
            const currentSafeName = (NameBoss && NameBoss.trim() !== "") 
                                    ? NameBoss 
                                    : (localStorage.getItem("timerBoss_name") || "Wybierz Bossa");

            el.bossName.textContent = "Boss: " + currentSafeName;
            
            const hb = Math.floor(TimeBoss / 3600);
            const mb = Math.floor((TimeBoss % 3600) / 60);
            const sb = TimeBoss % 60;
            el.bossDeaths.textContent = `Smierci: ${DeathsBoss}`;
            el.bossTime.textContent = `Time: ${hb > 0 ? (hb < 10 ? '0' + hb : hb) + ":" : ""}${(mb < 10 ? '0' + mb : mb)}:${(sb < 10 ? '0' + sb : sb)}`;

            localStorage.setItem("timerBoss_name", currentSafeName);
            localStorage.setItem("DeathsBoss_count", DeathsBoss);
            localStorage.setItem("timerBoss_time", TimeBoss);
        }
    }

    // --- LOGIKA CZASU ---
    setInterval(() => {
        if (isRunning) Time++;
        if (el.bossCont.style.visibility === "visible" && isRunningBoss) TimeBoss++;
        updateDisplay();
    }, 1000);

    // --- TWITCH COMMANDS ---
    function connectTwitch() {
        if (typeof ComfyJS === "undefined") {
            setTimeout(connectTwitch, 500);
            return;
        }

        ComfyJS.onCommand = (user, command, message, flags) => {
            if (!flags.broadcaster && !flags.mod) return;

            const cmd = command.toLowerCase();
            const msg = message ? message.trim() : "";

            if (cmd === "tbossstart") {
                // Jeśli wiadomość NIE jest pusta (użytkownik wpisał nazwę)
                if (msg.length > 0) {
                    NameBoss = msg;
                    DeathsBoss = 0;
                    TimeBoss = 0;
                    isRunningBoss = true;
                    el.bossCont.style.visibility = "visible";
                } 
                // Jeśli wiadomość JEST pusta (wpisano samo !tbossstart)
                else {
                    // Tylko jeśli już mamy jakąś nazwę, to pokazujemy panel
                    if (NameBoss.length > 0 || localStorage.getItem("timerBoss_name")) {
                        el.bossCont.style.visibility = "visible";
                        isRunningBoss = true;
                    }
                }
            }

            if (cmd === "tbossstop") {
                el.bossCont.style.visibility = "hidden";
                isRunningBoss = false;
                NameBoss = "";
                localStorage.setItem("timerBoss_name", "");
            }

            if (cmd === "tstart") {
                isRunning = true;
                if (el.bossCont.style.visibility === "visible") isRunningBoss = true;
            }

            if (cmd === "tstop") {
                isRunning = false;
                isRunningBoss = false;
            }

            if (cmd === "t+" || cmd === "tplus") {
                Deaths++;
                if (el.bossCont.style.visibility === "visible") DeathsBoss++;
            }

            if (cmd === "t-" || cmd === "tminus") {
                if (Deaths > 0) Deaths--;
                if (el.bossCont.style.visibility === "visible" && DeathsBoss > 0) DeathsBoss--;
            }

            if (cmd === "treset") {
                Time = 0;
                if (el.bossCont.style.visibility === "visible") TimeBoss = 0;
            }

            updateDisplay();
        };

        ComfyJS.Init("damiano00o");
    }

    // Start
    if (NameBoss !== "") el.bossCont.style.visibility = "visible";
    connectTwitch();
</script>
</body>

</html>
