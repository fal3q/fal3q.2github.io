<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer</title>
    

    <style>
        @font-face {
        font-family: 'MC-font';
        src: url('MinecraftRegular-Bmg3.otf') format('truetype');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
        }
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: transparent;
            overflow: hidden;
        }
        .Timer, .Deaths{
            color: white;
            -webkit-text-stroke: 3px black;
            font-size: 90px;
            letter-spacing: 5px;
            font-family: 'MC-font', serif;
        }
        .Boss{
            margin-top: 15px;

        }
        .TimerBoss, .DeathsBoss, .NameBoss{
            color: white;
            -webkit-text-stroke: 3px black;
            font-size: 90px;
            letter-spacing: 5px;
            font-family: 'MC-font', serif;
        }
    </style>
</head>
<body>
    <div class="Deaths">Smierci: 0</div>
    <div class="Timer">Time: 00:00</div>
    <div class="Boss" style="visibility: hidden;">
        <div class="NameBoss"></div>
        <div class="DeathsBoss"></div>
        <div class="TimerBoss"></div>
    </div>
<script>
    // Glowny Timer + śmierci
    let Time = localStorage.getItem("timer_time") ? parseInt(localStorage.getItem("timer_time")) : 0;
    let Deaths = localStorage.getItem("Deaths_count") ? parseInt(localStorage.getItem("Deaths_count")) : 0;
    let isRunning = false;
    const display_deaths = document.querySelector(".Deaths");
    const display_time = document.querySelector(".Timer");
    
    // Boss Timer + śmierci
    let NameBoss = localStorage.getItem("timerBoss_name") || "";
    let TimeBoss = localStorage.getItem("timerBoss_time") ? parseInt(localStorage.getItem("timerBoss_time")) : 0;
    let DeathsBoss = localStorage.getItem("DeathsBoss_count") ? parseInt(localStorage.getItem("DeathsBoss_count")) : 0;
    let isRunningBoss = false;
    const fullboss = document.querySelector(".Boss");
    const display_name_boss = document.querySelector(".NameBoss");
    const display_deaths_boss = document.querySelector(".DeathsBoss");
    const display_time_boss = document.querySelector(".TimerBoss");

    // Startowe sprawdzenie (pancerny warunek)
    if (NameBoss && typeof NameBoss === 'string' && NameBoss.trim() !== "") {
        fullboss.style.visibility = "visible";
    } else {
        fullboss.style.visibility = "hidden";
    }

    updateDisplay();

    function updateDisplay() {
        // Czas główny
        let h = Math.floor(Time / 3600);
        let m = Math.floor((Time % 3600) / 60);
        let s = Math.floor(Time % 60);
        let hDisplay = h > 0 ? (h < 10 ? '0' + h : h) + ":" : "";
        let mDisplay = (m < 10 ? '0' + m : m) + ":";
        let sDisplay = s < 10 ? '0' + s : s;

        display_deaths.textContent = "Smierci: " + Deaths;
        display_time.textContent = "Time: " + hDisplay + mDisplay + sDisplay;

        localStorage.setItem("Deaths_count", Deaths);
        localStorage.setItem("timer_time", Time);
        
        // Sekcja Bossa
        if (fullboss.style.visibility === "visible") {
            // Wyświetlamy nazwę tylko jeśli nie jest "pusta"
            if (NameBoss && NameBoss.trim() !== "") {
                display_name_boss.textContent = "Boss: " + NameBoss;
                localStorage.setItem("timerBoss_name", NameBoss);
            }

            let hBoss = Math.floor(TimeBoss / 3600);
            let mBoss = Math.floor((TimeBoss % 3600) / 60);
            let sBoss = Math.floor(TimeBoss % 60);
            let hDisplayBoss = hBoss > 0 ? (hBoss < 10 ? '0' + hBoss : hBoss) + ":" : "";
            let mDisplayBoss = (mBoss < 10 ? '0' + mBoss : mBoss) + ":";
            let sDisplayBoss = sBoss < 10 ? '0' + sBoss : sBoss;

            display_deaths_boss.textContent = "Smierci: " + DeathsBoss;
            display_time_boss.textContent = "Time: " + hDisplayBoss + mDisplayBoss + sDisplayBoss;
            
            localStorage.setItem("DeathsBoss_count", DeathsBoss);
            localStorage.setItem("timerBoss_time", TimeBoss);
        }
    }

    function TimeUp() {
        if (isRunning) Time++;
        if (fullboss.style.visibility === "visible" && isRunningBoss) TimeBoss++;
        updateDisplay();
    }

    function connectTwitch() {
        if (typeof ComfyJS !== "undefined") {
            ComfyJS.onCommand = (user, command, message, flags) => {
                if (flags.broadcaster || flags.mod) {
                    
                    if (command === "tbossstart") {
                        // REWOLUCJA TUTAJ: Sprawdzamy wiadomość ZANIM cokolwiek przypiszemy
                        const hasContent = message && message.trim().length > 0;

                        if (hasContent) {
                            // Nowy boss - tylko jeśli message ma treść!
                            NameBoss = message; 
                            DeathsBoss = 0;
                            TimeBoss = 0;
                            isRunningBoss = true;
                            fullboss.style.visibility = "visible";
                        } else {
                            // Puste !tbossstart - jeśli boss już "istnieje", po prostu go pokazujemy
                            if (NameBoss && NameBoss.trim() !== "") {
                                isRunningBoss = true;
                                fullboss.style.visibility = "visible";
                            }
                        }
                        updateDisplay();
                    }

                    // --- RESZTA KOMEND BEZ ZMIAN W LOGICE ---
                    if (command === "tstart") {
                        isRunning = true;
                        if (fullboss.style.visibility === "visible") isRunningBoss = true;
                    }
                    if (command === "tstop") {
                        isRunning = false;
                        isRunningBoss = false;
                    }
                    if (command === "tbossstop") {
                        fullboss.style.visibility = "hidden";
                        isRunningBoss = false;
                        NameBoss = "";
                        localStorage.setItem("timerBoss_name", "");
                        updateDisplay();
                    }
                    if (command === "tbosspause") {
                        isRunningBoss = false;
                        updateDisplay();
                    }
                    if (command === "tsetdeaths" || command === "t++") {
                        let val = parseInt(message);
                        if (!isNaN(val)) { Deaths = val; updateDisplay(); }
                    }
                    if (command === "tset") {
                        let totalSeconds = 0;
                        if (message.includes(":")) {
                            const parts = message.split(":").map(Number);
                            if (parts.length === 3) totalSeconds = (parts[0] * 3600) + (parts[1] * 60) + parts[2];
                            else if (parts.length === 2) totalSeconds = (parts[0] * 60) + parts[1];
                        } else {
                            totalSeconds = parseInt(message);
                        }
                        if (!isNaN(totalSeconds)) { Time = totalSeconds; updateDisplay(); }
                    }
                    if (command === "t+") {
                        Deaths++;
                        if (fullboss.style.visibility === "visible") DeathsBoss++;
                        updateDisplay();
                    }
                    if (command === "t-") {
                        Deaths--;
                        if (fullboss.style.visibility === "visible") DeathsBoss--;
                        updateDisplay();
                    }
                    if (command === "treset") {
                        Time = 0;
                        if (fullboss.style.visibility === "visible") TimeBoss = 0;
                        updateDisplay();
                    }
                }
            };
            ComfyJS.Init("damiano00o");
        } else {
            setTimeout(connectTwitch, 500);
        }
    }

    setInterval(TimeUp, 1000);
    connectTwitch();
</script>
</body>

</html>

