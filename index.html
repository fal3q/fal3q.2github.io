<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/comfy.js@latest/dist/comfy.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer</title>

    <style>
        @font-face {
            font-family: 'MC-font';
            src: url('MinecraftRegular-Bmg3.otf') format('truetype');
            font-display: swap;
        }

        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: transparent;
            overflow: hidden;
        }

        .Timer, .Deaths,
        .TimerBoss, .DeathsBoss, .NameBoss {
            color: white;
            -webkit-text-stroke: 3px black;
            font-size: 90px;
            letter-spacing: 5px;
            font-family: 'MC-font', serif;
        }

        .Boss {
            margin-top: 15px;
            visibility: hidden;
        }
    </style>
</head>

<body>
    <div class="Deaths">Smierci: 0</div>
    <div class="Timer">Time: 00:00</div>

    <div class="Boss">
        <div class="NameBoss"></div>
        <div class="DeathsBoss"></div>
        <div class="TimerBoss"></div>
    </div>

<script>
    // ===== GŁÓWNY TIMER =====
    let Time = localStorage.getItem("timer_time") ? parseInt(localStorage.getItem("timer_time")) : 0;
    let Deaths = localStorage.getItem("Deaths_count") ? parseInt(localStorage.getItem("Deaths_count")) : 0;
    let isRunning = false;

    const display_time = document.querySelector(".Timer");
    const display_deaths = document.querySelector(".Deaths");

    // ===== BOSS =====
    let NameBoss = localStorage.getItem("timerBoss_name") || "";
    let TimeBoss = localStorage.getItem("timerBoss_time") ? parseInt(localStorage.getItem("timerBoss_time")) : 0;
    let DeathsBoss = localStorage.getItem("DeathsBoss_count") ? parseInt(localStorage.getItem("DeathsBoss_count")) : 0;
    let isRunningBoss = false;

    const fullboss = document.querySelector(".Boss");
    const display_name_boss = document.querySelector(".NameBoss");
    const display_time_boss = document.querySelector(".TimerBoss");
    const display_deaths_boss = document.querySelector(".DeathsBoss");

    // startowe sprawdzenie
    if (NameBoss && NameBoss.trim() !== "") {
        fullboss.style.visibility = "visible";
    }

    function formatTime(sec) {
        let h = Math.floor(sec / 3600);
        let m = Math.floor((sec % 3600) / 60);
        let s = sec % 60;
        return (h > 0 ? String(h).padStart(2, "0") + ":" : "") +
               String(m).padStart(2, "0") + ":" +
               String(s).padStart(2, "0");
    }

    function updateDisplay() {
        display_time.textContent = "Time: " + formatTime(Time);
        display_deaths.textContent = "Smierci: " + Deaths;

        localStorage.setItem("timer_time", Time);
        localStorage.setItem("Deaths_count", Deaths);

        if (fullboss.style.visibility === "visible" && NameBoss.trim() !== "") {
            display_name_boss.textContent = "Boss: " + NameBoss;
            display_time_boss.textContent = "Time: " + formatTime(TimeBoss);
            display_deaths_boss.textContent = "Smierci: " + DeathsBoss;

            localStorage.setItem("timerBoss_name", NameBoss);
            localStorage.setItem("timerBoss_time", TimeBoss);
            localStorage.setItem("DeathsBoss_count", DeathsBoss);
        }
    }

    function TimeUp() {
        if (isRunning) Time++;
        if (isRunningBoss && fullboss.style.visibility === "visible") TimeBoss++;
        updateDisplay();
    }

    function connectTwitch() {
        if (!window.ComfyJS) {
            setTimeout(connectTwitch, 500);
            return;
        }

        ComfyJS.onCommand = (user, command, message, flags) => {
            if (!flags.broadcaster && !flags.mod) return;

            if (command === "tstart") {
                isRunning = true;
                if (fullboss.style.visibility === "visible") isRunningBoss = true;
            }

            if (command === "tstop") {
                isRunning = false;
                isRunningBoss = false;
            }

            // ===== POPRAWIONY tbossstart =====
            if (command === "tbossstart") {
                const hasMessage = message && message.trim() !== "";

                if (hasMessage) {
                    // nowy boss
                    NameBoss = message.trim();
                    TimeBoss = 0;
                    DeathsBoss = 0;
                    isRunningBoss = true;
                    fullboss.style.visibility = "visible";
                } else {
                    // BEZ WIADOMOŚCI:
                    // jeżeli boss jest UKRYTY → NIC NIE ROBIMY
                    if (fullboss.style.visibility === "hidden") return;

                    // jeżeli boss jest widoczny i ma nazwę → tylko wznawiamy
                    if (NameBoss && NameBoss.trim() !== "") {
                        isRunningBoss = true;
                    }
                }
                updateDisplay();
            }

            if (command === "tbossstop") {
                fullboss.style.visibility = "hidden";
                isRunningBoss = false;
                updateDisplay();
            }

            if (command === "t+") {
                Deaths++;
                if (fullboss.style.visibility === "visible") DeathsBoss++;
                updateDisplay();
            }

            if (command === "t-") {
                Deaths--;
                if (fullboss.style.visibility === "visible") DeathsBoss--;
                updateDisplay();
            }
        };

        ComfyJS.Init("damiano00o");
    }

    setInterval(TimeUp, 1000);
    connectTwitch();
    updateDisplay();
</script>
</body>
</html>
